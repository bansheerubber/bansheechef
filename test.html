<!DOCTYPE html>
<html>

<head>
</head>

<body>
	<video id="frog" autoplay></video>
</body>

<script>
	function requestBackend(
		endpoint,
		queryType = null,
		queryObject = null,
	) {
		return new Promise((resolve, reject) => {
			let request = new XMLHttpRequest()
			request.open(queryType || "GET", `https://localhost:5000${endpoint}`, true)
			request.responseType = "text"

			request.onload = (event) => {
				resolve(JSON.parse(request.response))
			}

			if (queryObject) {
				const formData = new FormData()
				for (const index in queryObject) {
					if (typeof queryObject[index] === "number") {
						formData.append(index, `${queryObject[index]}`)
					}
					else {
						formData.append(index, queryObject[index])
					}
				}
				request.send(formData)
			}
			else {
				request.send()
			}
		})
	}

	/*navigator.mediaDevices.getUserMedia({
		video: {
			width: {
				ideal: 1280,
			},
			height: {
				ideal: 720,
			},
		} 
	}).then((stream) => {
		document.getElementById("frog").srcObject = stream
	})*/

	const connection = new RTCPeerConnection({
		sdpSemantics: "unified-plan",
	})

	connection.addEventListener("track", (event) => {
		console.log("got track")
	})

	connection.addTransceiver(
		"video", {
			direction: "sendonly",
		}
	)

	connection.addTransceiver(
		"audio", {
			direction: "inactive",
		}
	)

	connection.createOffer().then(async (offer) => {
		await connection.setLocalDescription(offer)

		requestBackend("/barcode-offer", "POST", {
			sdp: connection.localDescription.sdp,
			type: connection.localDescription.type,
		}).then(async (offer) => {
			console.log("setting remote description", offer)
			await connection.setRemoteDescription(offer)
			console.log("set remote description")
		})
	})
</script>

</html>